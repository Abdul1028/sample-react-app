name: Pushly Auto Deploy (PRODUCTION)

on:
  push:
    branches:
      - main

jobs:
  deploy-production:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create Deployment
        run: |
          RESPONSE=$(curl -s -X POST "https://api.wareality.tech/api/projects/${{ secrets.PROJECT_ID }}/deployments" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.PUSHLY_TOKEN }}" \
            -d "{
              \"gitCommitHash\": \"${{ github.sha }}\",
              \"gitBranch\": \"main\",
              \"environment\": \"PRODUCTION\"
            }")

          DEPLOYMENT_ID=$(echo $RESPONSE | jq -r '.id')

          if [ -z "$DEPLOYMENT_ID" ] || [ "$DEPLOYMENT_ID" = "null" ]; then
            echo "‚ùå Failed to create deployment"
            exit 1
          fi

          echo "deployment_id=$DEPLOYMENT_ID" >> $GITHUB_ENV

      - name: Trigger Deployment
        run: |
          curl -s -X POST "https://api.wareality.tech/api/projects/${{ secrets.PROJECT_ID }}/deployments/${{ env.deployment_id }}/deploy?environment=PRODUCTION" \
            -H "Authorization: Bearer ${{ secrets.PUSHLY_TOKEN }}"

- name: Send Slack Notification
  if: always()
  run: |
    COMMIT_SHORT=$(echo "${{ github.sha }}" | cut -c1-7)

    if [ "${{ job.status }}" = "success" ]; then
      MESSAGE="‚úÖ Deployment successful for supply (PRODUCTION) | Commit: $COMMIT_SHORT | URL: https://supply.wareality.tech"
    else
      MESSAGE="‚ùå Deployment failed for supply (PRODUCTION) | Commit: $COMMIT_SHORT"
    fi

    MESSAGE_ESC=$(echo "$MESSAGE" | sed 's/"/\"/g')

    curl -X POST "${{ secrets.SLACK_WEBHOOK_URL }}" \
      -H "Content-Type: application/json" \
      -d "{\"text\": \"$MESSAGE_ESC\"}"

      - name: Done
        run: echo "üéâ Deployment triggered successfully"
